#include "stdafx.h"

#include "PortMappingContainer.h"

CPortMappingContainer::CPortMappingContainer()
{
}

CPortMappingContainer::CPortMappingContainer(const CPortMappingContainer &refSrc)
  : m_vector(refSrc.m_vector)
{
}

CPortMappingContainer::~CPortMappingContainer()
{
}

CPortMappingContainer &
CPortMappingContainer::operator=(const CPortMappingContainer &refSrc)
{
  m_vector = refSrc.m_vector;
  return *this;
}

void CPortMappingContainer::pushBack(CPortMapping element)
{
  m_vector.push_back(element);
}

size_t CPortMappingContainer::find(CPortMapping searchElement) const
{
  for (size_t i = 0; i < count(); i++) {
    CPortMapping each = m_vector.at(i);
    CPortMappingRect rect = each.GetRect();
    if (each.getPort() == searchElement.getPort() &&
        each.GetRect().IsEqualTo(&rect)) {
      return i;
    }
  }
  return (size_t)-1;
}

size_t CPortMappingContainer::findByPort(int port) const
{
  for (size_t i = 0; i < count(); i++) {
    if (m_vector.at(i).getPort() == port) {
      return i;
    }
  }
  return (size_t)-1;
}

void CPortMappingContainer::remove(size_t index)
{
  size_t i = 0;
  for (std::vector<CPortMapping>::iterator it = m_vector.begin();
       it != m_vector.end(); it++) {
    if (i == index) {
      m_vector.erase(it);
      break;
    }
    i++;
  }
}

void CPortMappingContainer::remove(CPortMapping removeMapping)
{
  size_t index = find(removeMapping);

  if (index != (size_t)-1) {
    remove(index);
  }
}

void CPortMappingContainer::removeAll()
{
  m_vector.clear();
}

size_t CPortMappingContainer::count() const
{
  return m_vector.size();
}

bool CPortMappingContainer::equals(const CPortMappingContainer *other) const
{
  if (count() != other->count()) {
    return false;
  }
  for (size_t i = 0; i < count(); i++) {
    if (!at(i)->IsEqualTo(other->at(i))) {
      return false;
    }
  }
  return true;
}

void CPortMappingContainer::serialize(CDataOutputStream *output) const
{
  _ASSERT((unsigned int)count() == count());
  output->WriteUInt32((unsigned int)count());

  CStringStorage string;

  for (size_t i = 0; i < count(); i++) {
    at(i)->toString(&string);

    output->writeUTF8(string.getString());
  }
}

void CPortMappingContainer::deserialize(CDataInputStream *input)
{
  removeAll();

  size_t cnt = input->ReadUInt32();

  CStringStorage string;

  CPortMapping record;

  for (size_t i = 0; i < cnt; i++) {

    input->readUTF8(&string);

    if (!CPortMapping::parse(string.getString(), &record)) {
      throw CException(_T("Invalid port mapping string"));
    }

    pushBack(record);
  }
}

const CPortMapping *CPortMappingContainer::at(size_t index) const
{
  bool outOfRange = index >= count();

  return outOfRange ? 0 : &m_vector.at(index);
}

CPortMapping *CPortMappingContainer::at(size_t index)
{
  bool outOfRange = index >= count();

  return outOfRange ? 0 : &m_vector.at(index);
}
